<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laboratoire d'Optimisation - OptiCem AI</title>
    <link rel="stylesheet" href="styles/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .form-input {
            text-align: left;
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar glass">
        <div class="logo" style="display: flex; align-items: center;">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a3/Holcim_logo.svg/2560px-Holcim_logo.svg.png"
                alt="Holcim" style="height: 24px; margin-right: 10px;">
            <span>OptiBlend</span>
        </div>
        <div class="nav-links">
            <span id="welcomeMsg" style="color: var(--text-main); font-weight: 500; margin-right: 15px;"></span>
            <button id="logoutBtn" class="btn btn-primary" style="padding: 8px 16px; font-size: 0.8rem;">
                <i class="fa-solid fa-right-from-bracket"></i> Déconnexion
            </button>
        </div>
    </nav>

    <!-- Sub-Navbar (Tabs) -->
    <div class="container" style="margin-top: 100px; margin-bottom: 20px;">
        <div class="glass"
            style="padding: 10px 20px; border-radius: 50px; display: flex; justify-content: space-around; align-items: center; background: white; flex-wrap: wrap;">
            <a href="/dashboard" class="btn"
                style="flex: 1; margin: 5px; text-align: center; color: var(--text-muted); background: transparent; box-shadow: none; white-space: nowrap;">
                <i class="fa-solid fa-satellite-dish"></i> Opérations (Live)
            </a>
            <a href="optimization_lab.html" class="btn btn-primary"
                style="flex: 1; margin: 5px; text-align: center; white-space: nowrap;">
                <i class="fa-solid fa-flask"></i> Laboratoire d'Optimisation
            </a>
            <a href="#" class="btn"
                style="flex: 1; margin: 5px; text-align: center; color: var(--text-muted); background: transparent; box-shadow: none; white-space: nowrap;">
                <i class="fa-solid fa-warehouse"></i> Inventaire
            </a>
            <a href="#" class="btn"
                style="flex: 1; margin: 5px; text-align: center; color: var(--text-muted); background: transparent; box-shadow: none; white-space: nowrap;">
                <i class="fa-solid fa-list-check"></i> Missions
            </a>
        </div>
    </div>


    <div class="container">
        <div class="dashboard-grid" style="grid-template-columns: 350px 1fr; padding-top: 10px;">

            <!-- Sidebar: Configuration -->
            <div class="kpi-card glass" style="text-align: left; background: white;">
                <h3
                    style="margin-bottom: 20px; border-bottom: 1px solid #e2e8f0; padding-bottom: 10px; color: var(--text-main); font-size: 1.1rem;">
                    <i class="fa-solid fa-sliders"></i> Paramètres Système
                </h3>

                <div
                    style="background: rgba(22, 163, 74, 0.05); border: 1px solid var(--primary); padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                    <div style="color: var(--primary); font-weight: 800; font-size: 0.9rem; text-transform: uppercase;">
                        Protocole Hybride 50/50 Actif</div>
                    <small style="color: var(--text-muted);">Charge de base (Petcoke) fixée à 50%</small>
                </div>

                <div style="margin-bottom: 20px;">
                    <label
                        style="font-size: 0.9rem; color: var(--text-muted); display: block; margin-bottom: 8px; font-weight: 600;">PCI
                        Minimum (kcal/kg)</label>
                    <input type="number" id="min_pci" value="3000" class="form-input">
                </div>

                <div style="margin-bottom: 20px;">
                    <label
                        style="font-size: 0.9rem; color: var(--text-muted); display: block; margin-bottom: 8px; font-weight: 600;">Chlore
                        Maximum (%)</label>
                    <input type="number" id="max_cl" value="0.03" step="0.01" class="form-input">
                </div>

                <div style="margin-bottom: 20px;">
                    <label
                        style="font-size: 0.9rem; color: var(--text-muted); display: block; margin-bottom: 8px; font-weight: 600;">Humidité
                        Maximum (%)</label>
                    <input type="number" id="max_h" value="0.25" step="0.01" class="form-input">
                </div>

                <h4
                    style="margin-top: 30px; margin-bottom: 15px; text-align: left; color: var(--text-main); font-size: 1rem;">
                    <i class="fa-solid fa-recycle"></i> Flux de Déchets
                </h4>
                <div id="waste-list" style="margin-bottom: 20px;">
                    <!-- Dynamic Items -->
                </div>

                <button onclick="addWasteStream()" class="btn glass"
                    style="width: 100%; margin-bottom: 20px; font-size: 0.9rem; border: 1px dashed #cbd5e1; color: var(--text-muted);">
                    <i class="fa-solid fa-plus"></i> Ajouter Flux
                </button>

                <!-- Trigger handled by script -->
            </div>

            <!-- Main Content: Results -->
            <div class="glass"
                style="background: #eefdf4; border-radius: 20px; padding: 40px; border: 1px solid #bbf7d0; min-height: 600px; display: flex; flex-direction: column;">
                <h3 style="text-align: left; margin-bottom: 30px; color: var(--primary); font-size: 1.3rem;">
                    <i class="fa-solid fa-chart-pie" style="margin-right: 10px;"></i> Résultats de la Simulation
                </h3>

                <!-- Idle State / Loading / Results handles here -->
                <div id="workspace-content"
                    style="flex: 1; display: flex; align-items: center; justify-content: center; text-align: center; color: #94a3b8;">
                    <div>
                        <i class="fa-solid fa-flask" style="font-size: 4rem; margin-bottom: 20px; color: #cbd5e1;"></i>
                        <p style="font-size: 1.1rem; font-weight: 500;">Configurez les paramètres et lancez une
                            simulation.</p>
                        <button onclick="solveOptimization()" class="btn btn-primary"
                            style="margin-top: 20px; padding: 15px 40px; font-size: 1.1rem;">
                            <i class="fa-solid fa-bolt"></i> Lancer la Simulation
                        </button>
                    </div>
                </div>

                <!-- Simulation Results View (Hidden by default) -->
                <div id="results-area" style="display:none; width: 100%;">
                    <!-- Summary KPIs -->
                    <div style="display: flex; gap: 20px; margin-bottom: 40px;">
                        <div
                            style="flex: 1; background: white; padding: 20px; border-radius: 15px; border: 1px solid #e2e8f0; text-align: center;">
                            <small
                                style="color: var(--text-muted); font-weight: 600; text-transform: uppercase;">Statut</small>
                            <div id="status-badge" style="font-size: 1.5rem; font-weight: 800; margin-top: 5px;">--
                            </div>
                        </div>
                        <div
                            style="flex: 1; background: white; padding: 20px; border-radius: 15px; border: 1px solid #e2e8f0; text-align: center;">
                            <small style="color: var(--text-muted); font-weight: 600; text-transform: uppercase;">PCI
                                Global</small>
                            <div style="font-size: 1.5rem; font-weight: 800; margin-top: 5px; color: var(--text-main);">
                                <span id="obj-val">--</span> <span
                                    style="font-size: 1rem; color: #94a3b8;">kcal/kg</span>
                            </div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 40px; align-items: start;">
                        <!-- Chart -->
                        <div>
                            <h4 style="text-align: left; margin-bottom: 20px; color: var(--text-muted);">Répartition du
                                Mélange</h4>
                            <div style="position: relative; height: 300px;">
                                <canvas id="mixChart"></canvas>
                                <!-- Center label -->
                                <div
                                    style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                    <div style="font-size: 2rem; font-weight: 800; color: var(--primary);">50/50</div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted);">Protocol</div>
                                </div>
                            </div>
                        </div>

                        <!-- Details -->
                        <div>
                            <h4 style="text-align: left; margin-bottom: 20px; color: var(--text-muted);">Analyse
                                Chimique</h4>

                            <div
                                style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #e2e8f0;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="color: var(--text-muted); font-size: 0.9rem;">Chlore (Cl)</span>
                                    <span id="res-cl" style="font-weight: 700;">--</span>
                                </div>
                                <div
                                    style="width: 100%; height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden;">
                                    <div id="bar-cl" style="width: 0%; height: 100%; background: var(--primary);"></div>
                                </div>
                            </div>

                            <div
                                style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #e2e8f0;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="color: var(--text-muted); font-size: 0.9rem;">Soufre (S)</span>
                                    <span id="res-s" style="font-weight: 700;">--</span>
                                </div>
                                <div
                                    style="width: 100%; height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden;">
                                    <div id="bar-s" style="width: 0%; height: 100%; background: #f59e0b;"></div>
                                </div>
                            </div>

                            <div
                                style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #e2e8f0;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="color: var(--text-muted); font-size: 0.9rem;">Humidité (H2O)</span>
                                    <span id="res-h" style="font-weight: 700;">--</span>
                                </div>
                                <div
                                    style="width: 100%; height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden;">
                                    <div id="bar-h" style="width: 0%; height: 100%; background: #0ea5e9;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 30px; text-align: center;">
                        <button
                            onclick="document.getElementById('results-area').style.display='none'; document.getElementById('workspace-content').style.display='flex';"
                            class="btn glass" style="color: var(--text-muted); background: white;">
                            <i class="fa-solid fa-arrow-left"></i> Nouvelle Simulation
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('welcomeMsg').textContent = 'Ingénieur : ' + (localStorage.getItem('user') || 'Invité');

        // Initial Data
        let wasteStreams = [
            { name: "Pneus", pci: 8000, chlorine: 0.01, sulfur: 0.015, humidity: 0.02 },
            { name: "RDF", pci: 4000, chlorine: 0.008, sulfur: 0.002, humidity: 0.15 },
            { name: "Grignon d'Olive", pci: 4500, chlorine: 0.001, sulfur: 0.001, humidity: 0.12 }
        ];

        function renderWasteList() {
            const container = document.getElementById('waste-list');
            container.innerHTML = '';
            wasteStreams.forEach((w, index) => {
                const div = document.createElement('div');
                div.style.background = 'white';
                div.style.padding = '15px';
                div.style.borderRadius = '12px';
                div.style.marginBottom = '15px';
                div.style.border = '1px solid #e2e8f0';
                div.style.boxShadow = '0 2px 4px rgba(0,0,0,0.02)';

                div.innerHTML = `
                    <div style="font-weight:700; color:var(--text-main); margin-bottom:10px; display:flex; justify-content:space-between; align-items: center;">
                        <span>${w.name}</span>
                        <i class="fa-solid fa-trash-can" style="color: #ef4444; cursor: pointer; opacity: 0.7;" onclick="removeStream(${index})"></i>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label style="font-size:0.7rem; color: #94a3b8; font-weight: 600;">PCI</label>
                            <input type="number" value="${w.pci}" onchange="updateStream(${index}, 'pci', this.value)" class="form-input" style="padding: 8px; margin-bottom:0; font-size: 0.9rem;">
                        </div>
                        <div>
                            <label style="font-size:0.7rem; color: #94a3b8; font-weight: 600;">Cl (%)</label>
                            <input type="number" value="${w.chlorine}" onchange="updateStream(${index}, 'chlorine', this.value)" class="form-input" style="padding: 8px; margin-bottom:0; font-size: 0.9rem;">
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateStream(index, field, value) {
            wasteStreams[index][field] = parseFloat(value);
        }

        function addWasteStream() {
            wasteStreams.push({ name: "Nouveau Flux", pci: 3000, chlorine: 0.01, sulfur: 0.1, humidity: 0.1 });
            renderWasteList();
        }

        function removeStream(index) {
            wasteStreams.splice(index, 1);
            renderWasteList();
        }

        async function solveOptimization() {
            const originalContent = document.getElementById('workspace-content').innerHTML;
            document.getElementById('workspace-content').innerHTML = `
                <i class="fa-solid fa-spinner fa-spin" style="font-size: 3rem; color: var(--primary);"></i>
                <p style="margin-top: 20px; font-weight: 500;">Optimisation en cours...</p>
            `;

            const payload = {
                waste_data: wasteStreams.map(w => ({ ...w, stock: 100 })),
                constraints: {
                    min_pci: parseFloat(document.getElementById('min_pci').value),
                    max_chlorine: parseFloat(document.getElementById('max_cl').value),
                    max_humidity: parseFloat(document.getElementById('max_h').value)
                }
            };

            try {
                const response = await fetch('/api/optimize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                // Reset content
                document.getElementById('workspace-content').innerHTML = originalContent;
                document.getElementById('workspace-content').style.display = 'none';

                renderResults(result);
            } catch (err) {
                alert("Erreur de connexion au serveur.");
                console.error(err);
                document.getElementById('workspace-content').innerHTML = originalContent;
            }
        }

        let chartInstance = null;
        function renderResults(data) {
            document.getElementById('results-area').style.display = 'block';

            // Metrics
            const statusEl = document.getElementById('status-badge');
            statusEl.textContent = data.status === 'Optimal' ? 'OPTIMAL' : 'INFEASIBLE';
            statusEl.style.color = data.status === 'Optimal' ? '#16a34a' : '#ef4444';

            document.getElementById('obj-val').textContent = data.objective_value;

            const cl = data.details.final_chlorine * 100;
            const h = data.details.final_humidity * 100;
            const s = data.details.final_sulfur * 100;

            document.getElementById('res-cl').textContent = cl.toFixed(3) + "%";
            document.getElementById('bar-cl').style.width = Math.min((cl / 1.0) * 100, 100) + "%"; // Mock max 1%

            document.getElementById('res-h').textContent = h.toFixed(3) + "%";
            document.getElementById('bar-h').style.width = Math.min((h / 30) * 100, 100) + "%"; // Mock max 30%

            document.getElementById('res-s').textContent = s.toFixed(3) + "%";
            document.getElementById('bar-s').style.width = Math.min((s / 5) * 100, 100) + "%"; // Mock max 5%

            // Chart Data Prep
            const labels = [];
            const values = [];
            const colors = [];
            const sortedMix = Object.entries(data.mix).sort((a, b) => b[1] - a[1]);

            const palette = ['#1e293b', '#16a34a', '#0d9488', '#f59e0b', '#6366f1', '#ec4899'];
            let colorIdx = 0;

            for (const [name, pct] of sortedMix) {
                if (pct > 0.01) {
                    let color;
                    if (name.includes("Petcoke")) color = '#1e293b'; // Slate 800
                    else if (name.includes("Pneus")) color = '#16a34a'; // Green 600
                    else if (name.includes("RDF")) color = '#d946ef'; // Fuchsia 500
                    else if (name.includes("Grignon")) color = '#65a30d'; // Lime 600
                    else if (name.includes("Plastique")) color = '#8b5cf6'; // Violet 500
                    else color = palette[colorIdx++ % palette.length];

                    labels.push(name + ` (${pct.toFixed(1)}%)`);
                    values.push(pct);
                    colors.push(color);
                }
            }

            // Chart
            const ctx = document.getElementById('mixChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors,
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { usePointStyle: true, boxWidth: 8 } }
                    },
                    cutout: '65%',
                    animation: {
                        animateScale: true,
                        animateRotate: true
                    }
                }
            });
        }

        // Init
        renderWasteList();

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('user');
            window.location.href = '/';
        });
    </script>
</body>

</html>